= Инструкция по установке ПО "Moon"
:revdate: {docdate}
:toc-title: Содержание
:front-cover-image: images/cover.png
:toc: left
:toclevels: 3
:sectnums:
:sectanchors:
:author: ООО "Аерокуб"
:revnumber: latest
:icons: font
:source-highlighter: coderay
:docinfo: shared

== О документе

Документ предназначен для технических специалистов, которые хотят установить полнофункциональную версию ПО "Moon".

== Глоссарий

**Программный процесс** - запущенный и работающий виде процесса операционной системы экземпляр программного обеспечения.

**Контейнеризация** - легковесная технология изоляции программных процессов, построенная на низкоуровневых возможностях ядра операционной системы Linux. Позволяет изолировать процессы по процессорным ядрам, оперативной памяти, сетевым подключениям, файловой системе. Работает значительно быстрее традиционной гипервизорной виртуализации. Примеры контейнерных технологий: https://www.docker.com/[Docker], https://coreos.com/rkt/[rkt].

**Контейнер** - программный процесс, изолированный от других программных процессов средствами контейнеризации.

**Kubernetes** - программное решение с https://github.com/kubernetes/kubernetes[открытым исходным кодом] для автоматического распределения произвольного количества контейнеров по произвольному набору серверов или виртуальных машин.

**Openshift** - коммерческое https://github.com/openshift/origin[программное решение] от компании https://www.redhat.com/[RedHat], построенное на основе Kubernetes и в значительной степени совместимое с ним.

**Сетевой балансировщик (LoadBalancer)** - специальное программно-аппаратное решение для распределения сетевых запросов по нескольких работающим копиям программного обеспечения, работающее на сетевом (L3) уровне https://en.wikipedia.org/wiki/OSI_model[модели OSI].

**Ингресс (Ingress)** - решение для распределения сетевых запросов по нескольких работающим копиям программного обеспечения, работающее на прикладном (L7) уровне https://en.wikipedia.org/wiki/OSI_model[модели OSI].

**Под (Pod)** - набор из одного или нескольких контейнеров, имеющих одинаковый сетевой адрес и запускаемых как единое целое в кластере Kubernetes \ Openshift.

**Сервис (Service)** - специальная сущность в Kubernetes \ Openshift, позволяющая назначить одному или нескольким подам постоянное доменное имя и определить алгоритм балансировки сетевой нагрузки на эти поды.

**Пространство имен** или **Неймспейс (Namespace)** или **Проект (Project)** - специальная сущность Kubernetes \ Openshift, позволяющий группировать остальные сущности в изолированные группы.

**YAML** - текстовый формат хранения данных, описанный на сайте https://yaml.org/[https://yaml.org/].

**Манифест*** - текстовое описание набора подов, сервисов, сетевых балансировщиков и других сущностей Kubernetes \ Openshift, которые требуется запустить для правильной работы ПО "Moon".

**Selenium** или **WebDriver** - программный протокол для запуска и управления браузерами и мобильными тестовыми средами, работающий поверх протокола HTTP. Подробное описание протокола дано по https://www.w3.org/TR/webdriver/[ссылке].

**Selenium URL** - сетевой адрес, используемый для запуска браузеров по протоколу Selenium и для взаимодействия с уже запущенными браузерами.

== Системные требования

* Современная операционная система (Linux, MacOS, Windows), имеющая интерпретатор командной строки
* **Для Kubernetes:** работающий кластер Kubernetes версии 1.13 и выше и установленная утилита https://github.com/kubernetes/kubectl[kubectl]
* **Для Openshift:** работающий кластер Openshift 3.10 и выше и установленная утилита https://github.com/openshift/oc[oc]

== Установка
=== Установка в Kubernetes

. Скачайте готовые YAML манифесты для разворачивания ПО "Moon" (например, при помощи `wget`):

    $ wget -O moon.yaml https://aerokube.ru/files/moon.yaml

. Выполните одну команду для запуска Moon:

    $ kubectl apply -f moon.yaml

+
По-умолчанию Moon запускается в отдельном пространстве имен `moon`, поэтому во всех последующих командах мы добавляем `-n moon`.
. Дождитесь пока будет выдан внешний IP-адрес у LoadBalancer:

    $ kubectl get svc -n moon
    NAME      TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
    moon      LoadBalancer   10.63.242.109   <pending>     4444:31894/TCP,8080:30625/TCP   17s
+
Когда операция завершится, это будет выглядеть вот так:

    $ kubectl get svc -n moon
    NAME      TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                         AGE
    moon      LoadBalancer   10.63.242.109   104.154.161.58   4444:31894/TCP,8080:30625/TCP   1m

+
Теперь вы можете дополнительно присвоить доменное имя выданному IP-адресу:

    $ host moon.example.com
    moon.example.ru has address 104.154.161.58

. Установка завершена! Вы можете запускать ваши Selenium-тесты через `moon`, используя следующий Selenium URL:

    http://104.154.161.58:4444/wd/hub

+
NOTE:  При первом запуске тестов для каждой версии браузера Kubernetes будет скачивать и кешировать образ контейнера этой версии браузера на диске. В зависимости от скорости сетевого соединения это может занять несколько минут.
+
При использовании доменного имени Selenium URL выглядит так:

    http://moon.example.com:4444/wd/hub


=== Установка в Openshift

. Скачайте готовые YAML манифесты для разворачивания ПО "Moon" (например, при помощи `wget`):

    $ wget -O moon-openshift.yaml https://aerokube.ru/files/moon-openshift.yaml

. Добавьте права на редактирование (`edit`) учетной записи `default`, чтобы Moon мог прочитать информацию о максимальном количестве подов, разрешенных для запуска в кластере:

    $ oc policy add-role-to-user edit system:serviceaccount:moon:default
+
Здесь предполагается, что Moon запускается в проекте с именем `moon`.

. Запустите Moon при помощи утилиты `oc` и файла `moon-openshift.yaml`:

    $ oc create -f moon-openshift.yaml -n moon

. Запустите ваши Selenium тесты, используя IP адрес от сервиса `moon` и сетевой порт `4444`:

    http://<moon-ip-or-hostname>:4444/wd/hub
